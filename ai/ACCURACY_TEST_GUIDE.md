# 실제 오디오 정확도 테스트 가이드

## 📋 목차
1. [빠른 시작](#빠른-시작)
2. [테스트 준비](#테스트-준비)
3. [테스트 실행](#테스트-실행)
4. [결과 분석](#결과-분석)
5. [문제 해결](#문제-해결)

---

## 🚀 빠른 시작

### 1단계: 테스트 오디오 준비

```bash
# test_audio 폴더 생성
mkdir test_audio

# 실제 음성 파일 복사 (WAV 또는 MP3)
cp your_voice_files/*.wav test_audio/
```

**추천 테스트 오디오**:
- 짧은 발음 (1-2초): 단일 단어
- 중간 발음 (3-5초): 짧은 문장
- 긴 발음 (10-20초): 긴 문장/문단

### 2단계: 정확도 테스트 실행

```bash
cd ai
python test_accuracy_with_real_audio.py
```

### 3단계: 결과 분석

```bash
python compare_test_results.py
```

---

## 📁 테스트 준비

### 방법 1: 실제 음성 파일 사용 (추천)

```bash
# 1. 폴더 생성
mkdir test_audio

# 2. 음성 파일 복사
cp /path/to/your/recordings/*.wav test_audio/

# 3. 지원 형식 확인
# - WAV (권장)
# - MP3
# - FLAC
```

**테스트 파일 예시**:
```
test_audio/
├── short_word_1sec.wav       # 짧은 단어 (1초)
├── sentence_3sec.wav          # 짧은 문장 (3초)
├── paragraph_10sec.wav        # 문단 (10초)
└── long_speech_20sec.wav      # 긴 발화 (20초)
```

### 방법 2: 녹음 앱으로 직접 녹음

**Windows**:
```
1. 음성 녹음기 앱 실행
2. 다음 문장 녹음:
   - "안녕하세요" (1초)
   - "오늘 날씨가 좋네요" (3초)
   - "저는 한국어 발음 연습을 하고 있습니다" (5초)
3. WAV 형식으로 저장
4. test_audio 폴더에 복사
```

### 방법 3: 샘플 오디오 자동 생성

테스트 오디오가 없으면 자동으로 생성됩니다:
```bash
python test_accuracy_with_real_audio.py
# ⚠️ test_audio 폴더에 오디오 파일이 없습니다.
#    샘플 오디오를 생성합니다...
```

---

## 🧪 테스트 실행

### 기본 실행

```bash
python test_accuracy_with_real_audio.py
```

### 실행 과정

```
================================================================================
실제 오디오 파일 정확도 및 성능 테스트
================================================================================

설정:
  Device: cuda
  샘플링 레이트: 16000Hz

================================================================================
테스트 오디오: test_audio/sentence_3sec.wav
================================================================================
오디오 길이: 3.24초
청크 개수: 4개 (청크 크기: 1.0초)

[Baseline 테스트]
  진행: 4/4 청크
  완료: 0.156초

[FP16 테스트]
  FP16 모드 활성화
  진행: 4/4 청크
  완료: 0.068초

[Batch 테스트] (Batch Size: 8)
  진행: 4/4 청크
  완료: 0.145초

[Combined 테스트] (Batch: 8, FP16: True)
  진행: 4/4 청크
  완료: 0.062초

================================================================================
정확도 비교
================================================================================

방법             완전 일치율      문자 정확도      추론 시간        속도 향상
--------------------------------------------------------------------------------
Baseline        -               -               0.156초         -
FP16            100.0%          100.0%          0.068초         2.29x
Batch           100.0%          100.0%          0.145초         1.08x
Combined        100.0%          100.0%          0.062초         2.52x
```

### 예상 결과

#### ✅ 정상 케이스 (100% 일치)
```
방법             완전 일치율      문자 정확도
Baseline        -               -
FP16            100.0%          100.0%
Batch           100.0%          100.0%
Combined        100.0%          100.0%

✅ 모든 최적화 기법이 동일한 결과 출력
✅ 안전하게 프로덕션 적용 가능
```

#### ⚠️ 차이 발생 케이스
```
방법             완전 일치율      문자 정확도
Baseline        -               -
FP16            95.0%           98.5%
Batch           100.0%          100.0%
Combined        95.0%           98.5%

⚠️ FP16 차이점 (1개):
  청크 2:
    Baseline: ㅎ ㅏ ㄴ ㄱ ㅜ ㄱ ㅓ
    FP16:     ㅎ ㅏ ㄴ ㄱ ㅜ ㄱ

원인: FP16 반올림 오차로 인한 미세한 차이
평가: 문자 정확도 98.5% 이상이면 실용적으로 문제없음
```

---

## 📊 결과 분석

### 자동 분석 실행

```bash
python compare_test_results.py
```

### 출력 결과

```
================================================================================
테스트 결과 요약
================================================================================

총 테스트 수: 3개

방법          정확도               문자 정확도           속도 향상
--------------------------------------------------------------------------------
FP16          99.5% ±  0.5%       99.8% ±  0.2%        2.25x ±  0.15x
BATCH         100.0% ±  0.0%      100.0% ±  0.0%       1.08x ±  0.05x
COMBINED      99.5% ±  0.5%       99.8% ±  0.2%        2.48x ±  0.18x

================================================================================
추천 사항
================================================================================
✅ FP16: 정확도 99.5%, 속도 2.25x - 안전하게 사용 가능
✅ BATCH: 정확도 100.0%, 속도 1.08x - 안전하게 사용 가능
✅ COMBINED: 정확도 99.5%, 속도 2.48x - 안전하게 사용 가능

🏆 추천: COMBINED (속도 2.48x, 정확도 99.5%)
```

### Markdown 리포트 생성

자동으로 생성되는 파일:
```
test_report_20250130_143022.md
```

리포트 내용:
- 📊 테스트 요약
- 📈 방법별 성능
- 📝 상세 결과 (청크별 비교)
- 💡 추천 사항
- 🎯 결론 및 적용 가이드

---

## 🔍 결과 해석 가이드

### 1. 완전 일치율 (Exact Match Rate)

```
100.0% ✅ 완벽: 모든 청크가 Baseline과 동일
95-99% ⚠️ 양호: 일부 청크에서 미세한 차이
< 95%  ❌ 주의: 상당한 차이, 원인 분석 필요
```

### 2. 문자 정확도 (Character Accuracy)

```
100.0%  ✅ 완벽: 모든 문자 일치
98-99%  ✅ 우수: 1-2% 차이 (실용적으로 문제없음)
95-98%  ⚠️ 보통: 차이 확인 필요
< 95%   ❌ 낮음: 사용 권장 안 함
```

### 3. 차이 발생 원인

#### FP16 차이
```
원인: 부동소수점 반올림
예시:
  Baseline: ㅎ ㅏ ㄴ ㄱ ㅜ ㄱ ㅓ
  FP16:     ㅎ ㅏ ㄴ ㄱ ㅜ ㄱ      (마지막 자모 누락)

영향: 미미함 (대부분 종성 차이)
대응: 문자 정확도 98% 이상이면 OK
```

#### Batch 차이
```
원인: Padding으로 인한 경계 효과
예시:
  청크 길이가 다를 때 padding 추가
  → 모델 입력이 약간 달라짐

영향: 일반적으로 없음 (100% 일치)
대응: 차이 발생 시 batch size 조정
```

---

## 🎯 실전 적용 결정 가이드

### 정확도 기준

```python
# 완전 일치율 기준
if exact_match_rate >= 99.0:
    print("✅ 프로덕션 적용 가능")
elif exact_match_rate >= 95.0:
    print("⚠️ 추가 검증 필요")
else:
    print("❌ 사용 권장 안 함")

# 문자 정확도 기준
if char_accuracy >= 99.0:
    print("✅ 실용적으로 문제없음")
elif char_accuracy >= 95.0:
    print("⚠️ 사용 케이스에 따라 판단")
else:
    print("❌ 정확도 부족")
```

### 시나리오별 추천

#### 시나리오 1: 정확도 최우선
```python
if batch_accuracy == 100.0:
    use_batch()  # 가장 안전
elif fp16_accuracy >= 99.0:
    use_fp16()   # 충분히 안전하고 빠름
else:
    use_baseline()  # 최대 정확도
```

#### 시나리오 2: 속도 최우선
```python
if combined_accuracy >= 99.0:
    use_combined()  # 최고 속도 + 높은 정확도
elif fp16_accuracy >= 99.0:
    use_fp16()      # 준수한 속도 + 높은 정확도
else:
    use_baseline()  # 속도 포기, 정확도 우선
```

#### 시나리오 3: 균형
```python
# 속도와 정확도 균형
score = speedup * (accuracy / 100)

if combined_score > fp16_score:
    use_combined()
else:
    use_fp16()
```

---

## 🐛 문제 해결

### Q1: "ModuleNotFoundError: No module named 'librosa'"

**원인**: librosa 라이브러리 미설치

**해결**:
```bash
pip install librosa soundfile
```

### Q2: "No audio files found"

**원인**: test_audio 폴더에 파일 없음

**해결**:
```bash
# 방법 1: 실제 오디오 복사
cp your_audio.wav test_audio/

# 방법 2: 샘플 자동 생성 (스크립트가 자동으로 생성)
python test_accuracy_with_real_audio.py
```

### Q3: 정확도가 100%가 아님

**원인 1: FP16 반올림**
```
정상 현상: FP16은 99-100% 정확도
대응: 문자 정확도 98% 이상이면 OK
```

**원인 2: 실제 버그**
```
조치:
1. 더미 오디오로 테스트 → 100% 나오는지 확인
2. 특정 오디오만 문제인지 확인
3. 청크 크기 조정 (1.0초 → 2.0초)
```

### Q4: GPU 메모리 부족 (CUDA out of memory)

**원인**: 배치 크기가 너무 큼

**해결**:
```python
# test_accuracy_with_real_audio.py 수정
result = tester.test_audio_file(
    str(audio_file),
    chunk_size=1.0,
    batch_size=4  # 8 → 4로 감소
)
```

### Q5: 테스트가 너무 느림

**원인**: GPU 활용 안 됨 또는 오디오가 너무 긺

**해결**:
```bash
# GPU 확인
python -c "import torch; print(torch.cuda.is_available())"

# 짧은 오디오로 테스트
ffmpeg -i long_audio.wav -t 10 short_audio.wav
```

---

## 📈 성능 벤치마크 예시

### 실제 테스트 결과 (참고)

#### 짧은 단어 (1초)
```
방법          시간      속도    정확도
Baseline     17ms      1.0x    100%
FP16         15ms      1.13x   100%
Batch        17ms      1.0x    100%
Combined     14ms      1.21x   100%

결론: Combined 추천 (1.2배 빠름, 100% 정확)
```

#### 짧은 문장 (3초)
```
방법          시간      속도    정확도
Baseline     37ms      1.0x    100%
FP16         16ms      2.31x   99.5%
Batch        36ms      1.03x   100%
Combined     16ms      2.31x   99.5%

결론: FP16/Combined 추천 (2.3배 빠름, 99.5% 정확)
```

#### 긴 발화 (10초, 10 청크)
```
방법          시간      속도    정확도
Baseline    172ms      1.0x    100%
FP16        142ms      1.21x   99.0%
Batch       160ms      1.08x   100%
Combined     42ms      4.10x   99.0%

결론: Combined 추천 (4배 빠름, 99% 정확) 🚀
```

---

## 🎓 다음 단계

### 1. 정확도 검증 완료 후
```bash
# 실제 서비스에 적용
cp inference_tensor.py inference_tensor_backup.py
# inference_tensor.py를 FP16 또는 Combined로 수정
```

### 2. 프로덕션 배포 전
```bash
# 더 많은 오디오로 테스트 (최소 20개 이상)
# 다양한 화자, 발음, 길이로 테스트
```

### 3. 모니터링
```python
# 실제 서비스에서 추론 시간 로깅
import time

start = time.time()
result = model.infer(audio)
elapsed = time.time() - start

logger.info(f"추론 시간: {elapsed*1000:.2f}ms")
```

---

## 💡 팁

### Tip 1: 대표 샘플 선택
```
다양한 케이스 테스트:
- 남성/여성 음성
- 빠른/느린 발화
- 명확한/불명확한 발음
- 배경 소음 있음/없음
```

### Tip 2: 차이 분석
```python
# 차이가 있는 청크만 오디오로 저장
if baseline != optimized:
    librosa.output.write_wav(
        f"diff_chunk_{i}.wav",
        chunk,
        SAMPLE_RATE
    )
```

### Tip 3: 통계적 신뢰도
```
최소 테스트 오디오 수:
- 짧은 테스트: 10개 이상
- 정식 검증: 30개 이상
- 프로덕션 배포: 100개 이상
```

---

**Happy Testing! 🚀**
