stages: [test, deploy]

variables:
  AI_IMAGE_NAME: korean-pronunciation-ai
  AI_IMAGE_TAG: latest
  AI_SERVER_IP: "3.36.239.57"

# AI 서버 테스트 (로컬에서 실행)
test-ai:
  stage: test
  image: python:3.10-slim
  tags: ["docker"]
  rules:
    - if: '$CI_COMMIT_BRANCH =~ /^(ai-dev|master)$/'
      changes:
        - "ai/**"
        - ".gitlab-ci.yml"
  before_script:
    - cd ai
    - apt-get update && apt-get install -y ffmpeg libsndfile1
    - pip install --no-cache-dir -r requirements.txt
  script:
    - echo "Running tests..."
    - pytest tests/ -v --tb=short
    - echo "Tests passed!"
  artifacts:
    reports:
      junit: ai/test-results.xml
    when: always
  cache:
    paths:
      - .pytest_cache/

# 서버에서 직접 빌드 및 배포
deploy-ai:
  stage: deploy
  image: alpine:3.20
  rules:
    - if: '$CI_COMMIT_BRANCH =~ /^(ai-dev|master)$/'
      changes:
        - "ai/**"
        - ".gitlab-ci.yml"
  before_script:
    - apk add --no-cache openssh-client curl
    - eval $(ssh-agent -s)
    - echo "$AI_SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan -H "$AI_SERVER_IP" >> ~/.ssh/known_hosts
  script:
    - echo "Deploying AI server to EC2..."

    # 서버에서 코드 업데이트 및 Docker 빌드
    - |
      ssh "$AI_SERVER_USER@$AI_SERVER_IP" << 'EOF'
        set -e
        cd /home/ubuntu/S13P31A206

        echo "Updating code from git..."
        git fetch origin
        git checkout ai-dev
        git pull origin ai-dev

        cd ai

        echo "Building Docker image on server..."
        docker build -t korean-pronunciation-ai:latest .

        echo "Stopping old container..."
        docker compose down || true

        echo "Starting new container..."
        docker compose up -d

        echo "Waiting for service to start..."
        sleep 15

        echo "Health check..."
        curl -fsS http://localhost:8000/health/

        echo "AI server deployed successfully!"
      EOF
  environment:
    name: ai
    url: http://$AI_SERVER_IP:8000
  tags: ["docker"]
